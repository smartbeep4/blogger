<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ post.title }} - Interactive Blog</title>
    <meta name="description" content="{{ post.title }}">
    {% if post.categories %}
        <meta name="keywords" content="{{ post.tags|join(', ') }}">
    {% endif %}
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body class="bg-gray-50 theme-light" x-data="postApp()">
    <!-- Navigation -->
    <nav class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <a href="{{ url_for('main.index') }}" class="text-xl font-bold text-gray-900 hover:text-gray-700">
                            Interactive Blog
                        </a>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="{{ url_for('main.index') }}" class="text-gray-500 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Home
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Theme Toggle -->
                    <button id="theme-toggle" class="p-2 rounded-md text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-moon"></i>
                    </button>

                    {% if current_user.is_authenticated %}
                        <a href="{{ url_for('main.editor', post_id=post.id) }}" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-md text-sm font-medium">
                            Edit Post
                        </a>
                        <a href="{{ url_for('main.dashboard') }}" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">
                            Dashboard
                        </a>
                        <a href="{{ url_for('main.logout') }}" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">
                            Logout
                        </a>
                    {% else %}
                        <a href="{{ url_for('main.login') }}" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-md text-sm font-medium">
                            Login
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Breadcrumb -->
        <nav class="mb-6" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2 text-sm text-gray-500">
                <li><a href="{{ url_for('main.index') }}" class="hover:text-gray-700">Home</a></li>
                <li><i class="fas fa-chevron-right text-gray-400"></i></li>
                {% if post.categories %}
                    {% for category in post.categories %}
                        <li><a href="{{ url_for('main.category', category=category) }}" class="hover:text-gray-700">{{ category }}</a></li>
                        {% if not loop.last %}<li><i class="fas fa-chevron-right text-gray-400"></i></li>{% endif %}
                    {% endfor %}
                {% else %}
                    <li><span class="text-gray-900">Post</span></li>
                {% endif %}
            </ol>
        </nav>

        <!-- Post Header -->
        <header class="mb-8">
            <div class="flex items-center space-x-2 mb-4">
                {% if post.categories %}
                    {% for category in post.categories %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                            {{ category }}
                        </span>
                    {% endfor %}
                {% endif %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                    Published
                </span>
            </div>

            <h1 class="text-4xl font-bold text-gray-900 mb-4">{{ post.title }}</h1>

            <div class="flex items-center space-x-6 text-sm text-gray-500">
                <div class="flex items-center">
                    <i class="fas fa-user mr-2"></i>
                    <span>{{ post.author.username }}</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-calendar mr-2"></i>
                    <span>{{ post.published_at.strftime('%B %d, %Y') if post.published_at else post.created_at.strftime('%B %d, %Y') }}</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-eye mr-2"></i>
                    <span>{{ post.views }} views</span>
                </div>
            </div>
        </header>

        <!-- Post Content -->
        <article class="prose prose-lg max-w-none mb-8">
            <div id="post-content" class="post-content">
                {{ content|safe }}
            </div>
        </article>

        <!-- Tags -->
        {% if post.tags %}
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Tags</h3>
                <div class="flex flex-wrap gap-2">
                    {% for tag in post.tags %}
                        <a href="{{ url_for('main.tag', tag=tag) }}" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800 hover:bg-gray-200 transition-colors">
                            #{{ tag }}
                        </a>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- Social Sharing -->
        <div class="border-t border-gray-200 pt-8 mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Share this post</h3>
            <div class="flex space-x-4">
                <button onclick="shareOnTwitter()" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fab fa-twitter mr-2 text-blue-500"></i>
                    Twitter
                </button>
                <button onclick="shareOnFacebook()" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fab fa-facebook mr-2 text-blue-600"></i>
                    Facebook
                </button>
                <button onclick="copyLink()" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fas fa-link mr-2 text-gray-500"></i>
                    Copy Link
                </button>
            </div>
        </div>

        <!-- Comments/Interactions Section -->
        <div class="border-t border-gray-200 pt-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Engage with this content</h3>
            <p class="text-gray-600">This post contains interactive elements. Try the quizzes and explore the embedded content!</p>
        </div>
    </div>

    <!-- PDF Modal -->
    <div x-show="showPdfModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        <div class="relative top-10 mx-auto p-5 border w-11/12 h-5/6 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">PDF Viewer</h3>
                <button @click="showPdfModal = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="w-full h-full">
                <canvas id="pdf-canvas" class="border border-gray-300 w-full h-4/5"></canvas>
                <div class="flex justify-center space-x-4 mt-4">
                    <button @click="prevPdfPage()" :disabled="currentPdfPage <= 1" class="px-4 py-2 bg-gray-500 text-white rounded disabled:opacity-50">
                        Previous
                    </button>
                    <span class="px-4 py-2">Page {{ currentPdfPage }} of {{ totalPdfPages }}</span>
                    <button @click="nextPdfPage()" :disabled="currentPdfPage >= totalPdfPages" class="px-4 py-2 bg-gray-500 text-white rounded disabled:opacity-50">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Post JavaScript -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('postApp', () => ({
                showPdfModal: false,
                currentPdfPage: 1,
                totalPdfPages: 0,
                pdfDoc: null,

                init() {
                    this.initializeInteractives();
                },

                initializeInteractives() {
                    // Initialize quizzes
                    const quizElements = document.querySelectorAll('[data-quiz-id]');
                    quizElements.forEach(element => {
                        this.loadQuiz(element);
                    });

                    // Initialize charts
                    const chartElements = document.querySelectorAll('[data-chart-id]');
                    chartElements.forEach(element => {
                        this.loadChart(element);
                    });

                    // Initialize videos
                    const videoElements = document.querySelectorAll('[data-video-id]');
                    videoElements.forEach(element => {
                        this.loadVideo(element);
                    });

                    // Initialize PDFs
                    const pdfElements = document.querySelectorAll('[data-pdf-id]');
                    pdfElements.forEach(element => {
                        this.setupPdf(element);
                    });
                },

                async loadQuiz(element) {
                    const quizId = element.getAttribute('data-quiz-id');
                    try {
                        const response = await fetch(`/api/quiz/${quizId}`);
                        const data = await response.json();

                        element.innerHTML = this.renderQuiz(data);
                        this.attachQuizHandlers(element, data);
                    } catch (error) {
                        console.error('Failed to load quiz:', error);
                        element.innerHTML = '<p class="text-red-500">Failed to load quiz</p>';
                    }
                },

                renderQuiz(quizData) {
                    const questions = quizData.questions || [];
                    if (questions.length === 0) return '<p>No questions available</p>';

                    const question = questions[0]; // For simplicity, show first question
                    let html = `<div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-4">
                        <h4 class="text-lg font-semibold text-blue-900 mb-4">${question.question}</h4>`;

                    if (question.type === 'multiple_choice') {
                        html += '<div class="space-y-2">';
                        question.options.forEach((option, index) => {
                            html += `<label class="flex items-center">
                                <input type="radio" name="quiz-answer" value="${option}" class="mr-2">
                                <span>${option}</span>
                            </label>`;
                        });
                        html += '</div>';
                    } else if (question.type === 'true_false') {
                        html += `<div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="quiz-answer" value="True" class="mr-2">
                                <span>True</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="quiz-answer" value="False" class="mr-2">
                                <span>False</span>
                            </label>
                        </div>`;
                    }

                    html += `<button class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md submit-quiz">
                        Submit Answer
                    </button>
                    <div class="feedback mt-2 hidden"></div>
                </div>`;

                    return html;
                },

                attachQuizHandlers(element, quizData) {
                    const submitBtn = element.querySelector('.submit-quiz');
                    const feedbackDiv = element.querySelector('.feedback');

                    submitBtn.addEventListener('click', () => {
                        const selectedAnswer = element.querySelector('input[name="quiz-answer"]:checked');
                        if (!selectedAnswer) {
                            feedbackDiv.innerHTML = '<p class="text-red-600">Please select an answer</p>';
                            feedbackDiv.classList.remove('hidden');
                            return;
                        }

                        const answer = selectedAnswer.value;
                        const question = quizData.questions[0];
                        const isCorrect = answer === question.answer;

                        feedbackDiv.innerHTML = isCorrect
                            ? '<p class="text-green-600">Correct! Well done.</p>'
                            : `<p class="text-red-600">Incorrect. The correct answer is: ${question.answer}</p>`;
                        feedbackDiv.classList.remove('hidden');

                        // Log quiz attempt
                        this.logQuizAttempt(quizData.id, isCorrect ? 'success' : 'attempt');
                    });
                },

                async loadChart(element) {
                    const chartId = element.getAttribute('data-chart-id');
                    try {
                        const response = await fetch(`/api/chart/${chartId}`);
                        const data = await response.json();

                        const canvas = document.createElement('canvas');
                        canvas.width = 400;
                        canvas.height = 300;
                        element.appendChild(canvas);

                        new Chart(canvas, data);
                    } catch (error) {
                        console.error('Failed to load chart:', error);
                        element.innerHTML = '<p class="text-red-500">Failed to load chart</p>';
                    }
                },

                async loadVideo(element) {
                    const videoId = element.getAttribute('data-video-id');
                    try {
                        const response = await fetch(`/api/video/${videoId}`);
                        const data = await response.json();

                        element.innerHTML = `<video controls class="max-w-full h-auto rounded-lg shadow-lg">
                            <source src="${data.url}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>`;
                    } catch (error) {
                        console.error('Failed to load video:', error);
                        element.innerHTML = '<p class="text-red-500">Failed to load video</p>';
                    }
                },

                setupPdf(element) {
                    const pdfId = element.getAttribute('data-pdf-id');
                    element.innerHTML = `<button class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md view-pdf" data-pdf-id="${pdfId}">
                        <i class="fas fa-file-pdf mr-2"></i>
                        View PDF
                    </button>`;

                    const button = element.querySelector('.view-pdf');
                    button.addEventListener('click', () => {
                        this.loadPdf(pdfId);
                    });
                },

                async loadPdf(pdfId) {
                    try {
                        const response = await fetch(`/api/pdf/${pdfId}`);
                        const data = await response.json();

                        // Load PDF using PDF.js
                        const loadingTask = pdfjsLib.getDocument(data.url);
                        this.pdfDoc = await loadingTask.promise;
                        this.totalPdfPages = this.pdfDoc.numPages;
                        this.currentPdfPage = 1;
                        this.showPdfModal = true;

                        this.renderPdfPage(1);
                    } catch (error) {
                        console.error('Failed to load PDF:', error);
                        alert('Failed to load PDF');
                    }
                },

                async renderPdfPage(pageNum) {
                    const page = await this.pdfDoc.getPage(pageNum);
                    const scale = 1.5;
                    const viewport = page.getViewport({scale: scale});

                    const canvas = document.getElementById('pdf-canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    await page.render(renderContext).promise;
                },

                prevPdfPage() {
                    if (this.currentPdfPage <= 1) return;
                    this.currentPdfPage--;
                    this.renderPdfPage(this.currentPdfPage);
                },

                nextPdfPage() {
                    if (this.currentPdfPage >= this.totalPdfPages) return;
                    this.currentPdfPage++;
                    this.renderPdfPage(this.currentPdfPage);
                },

                async logQuizAttempt(quizId, eventType) {
                    try {
                        await fetch('/api/log_quiz', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                quiz_id: quizId,
                                event_type: eventType
                            })
                        });
                    } catch (error) {
                        console.error('Failed to log quiz attempt:', error);
                    }
                }
            }));
        });

        // Theme toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('theme-toggle');
            const html = document.documentElement;

            const savedTheme = localStorage.getItem('theme') || 'light';
            html.classList.toggle('theme-dark', savedTheme === 'dark');
            html.classList.toggle('theme-gray', savedTheme === 'gray');
            updateThemeIcon(savedTheme);

            themeToggle.addEventListener('click', function() {
                const currentTheme = localStorage.getItem('theme') || 'light';
                let newTheme;

                if (currentTheme === 'light') {
                    newTheme = 'dark';
                } else if (currentTheme === 'dark') {
                    newTheme = 'gray';
                } else {
                    newTheme = 'light';
                }

                localStorage.setItem('theme', newTheme);
                html.classList.toggle('theme-light', newTheme === 'light');
                html.classList.toggle('theme-dark', newTheme === 'dark');
                html.classList.toggle('theme-gray', newTheme === 'gray');
                updateThemeIcon(newTheme);
            });

            function updateThemeIcon(theme) {
                const icon = themeToggle.querySelector('i');
                if (theme === 'dark') {
                    icon.className = 'fas fa-sun';
                } else if (theme === 'gray') {
                    icon.className = 'fas fa-adjust';
                } else {
                    icon.className = 'fas fa-moon';
                }
            }
        });

        // Social sharing functions
        function shareOnTwitter() {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent("Check out this post: {{ post.title }}");
            window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
        }

        function shareOnFacebook() {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
        }

        async function copyLink() {
            try {
                await navigator.clipboard.writeText(window.location.href);
                alert('Link copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy link:', err);
                alert('Failed to copy link');
            }
        }
    </script>
</body>
</html>
